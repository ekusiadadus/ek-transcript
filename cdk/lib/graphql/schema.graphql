# ek-transcript GraphQL Schema
# Cognito User Pool 認証必須

type Interview @aws_cognito_user_pools {
  interview_id: ID!
  project_id: String
  segment: String!
  created_at: AWSDateTime!
  status: String
  analysis_key: String
  transcript_key: String
  video_key: String
  diarization_key: String
  total_score: Int
  user_id: String
  file_name: String
  file_size: Int
  execution_arn: String
  updated_at: AWSDateTime
  # Progress tracking fields
  progress: Int
  current_step: String
  error_message: String
}

# ========================================
# Interview Project Types
# ========================================

enum ProjectStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

type InterviewProject @aws_cognito_user_pools {
  project_id: ID!
  user_id: String!
  title: String!
  description: String
  recruitment_criteria: String
  research_questions: String
  target_persona: String
  status: ProjectStatus!
  interview_count: Int
  created_at: AWSDateTime!
  updated_at: AWSDateTime
}

type InterviewProjectConnection @aws_cognito_user_pools {
  items: [InterviewProject!]!
  nextToken: String
}

type InterviewConnection @aws_cognito_user_pools {
  items: [Interview!]!
  nextToken: String
}

type UploadUrlResponse @aws_cognito_user_pools {
  uploadUrl: String!
  key: String!
  expiresIn: Int!
}

type VideoUrlResponse @aws_cognito_user_pools {
  videoUrl: String!
  expiresIn: Int!
}

type Query {
  # 単一インタビュー取得
  getInterview(interview_id: ID!): Interview
    @aws_cognito_user_pools

  # インタビュー一覧取得（ページネーション対応）
  listInterviews(limit: Int, nextToken: String): InterviewConnection
    @aws_cognito_user_pools

  # セグメント別インタビュー取得
  listInterviewsBySegment(
    segment: String!
    limit: Int
    nextToken: String
  ): InterviewConnection
    @aws_cognito_user_pools

  # S3アップロード用Presigned URL取得
  getUploadUrl(
    fileName: String!
    contentType: String
    segment: String
    projectId: ID
  ): UploadUrlResponse
    @aws_cognito_user_pools

  # S3動画再生用Presigned URL取得
  getVideoUrl(key: String!): VideoUrlResponse
    @aws_cognito_user_pools

  # ========================================
  # Google Meet Integration Queries
  # ========================================

  # 単一会議取得
  getMeeting(meeting_id: ID!): Meeting
    @aws_cognito_user_pools

  # 会議一覧取得（ページネーション対応）
  listMeetings(
    limit: Int
    nextToken: String
    status: MeetingStatus
  ): MeetingConnection
    @aws_cognito_user_pools

  # 日付範囲で会議取得
  listMeetingsByDateRange(
    start_date: AWSDateTime!
    end_date: AWSDateTime!
    limit: Int
    nextToken: String
  ): MeetingConnection
    @aws_cognito_user_pools

  # ========================================
  # Google OAuth Queries
  # ========================================

  # Google OAuth 認証 URL 取得
  getGoogleAuthUrl(redirect_uri: String!): GoogleAuthUrlResponse
    @aws_cognito_user_pools

  # Google 接続状態確認
  getGoogleConnectionStatus: GoogleConnectionStatus
    @aws_cognito_user_pools

  # ========================================
  # Recordings Cache Queries
  # ========================================

  # 録画一覧取得（キャッシュから高速取得）
  listRecordings(status: RecordingStatus): RecordingsConnection
    @aws_cognito_user_pools

  # ========================================
  # Interview Project Queries
  # ========================================

  # 単一プロジェクト取得
  getInterviewProject(project_id: ID!): InterviewProject
    @aws_cognito_user_pools

  # プロジェクト一覧取得（ページネーション対応）
  listInterviewProjects(
    limit: Int
    nextToken: String
    status: ProjectStatus
  ): InterviewProjectConnection
    @aws_cognito_user_pools

  # プロジェクト内のインタビュー一覧取得
  listInterviewsByProject(
    project_id: ID!
    limit: Int
    nextToken: String
  ): InterviewConnection
    @aws_cognito_user_pools
}

type RecordingsConnection @aws_cognito_user_pools {
  items: [Recording!]!
  nextToken: String
}

type Mutation {
  # インタビュー作成（Step Functions から呼び出し - IAM 認証）
  createInterview(input: CreateInterviewInput!): Interview
    @aws_iam

  # インタビュー更新
  updateInterview(input: UpdateInterviewInput!): Interview
    @aws_cognito_user_pools

  # インタビュー削除
  deleteInterview(interview_id: ID!): Interview
    @aws_cognito_user_pools

  # ========================================
  # Google Meet Integration Mutations
  # ========================================

  # 会議作成（Google Calendar + Meet Space 作成）
  createMeeting(input: CreateMeetingInput!): Meeting
    @aws_cognito_user_pools

  # 会議更新
  updateMeeting(input: UpdateMeetingInput!): Meeting
    @aws_cognito_user_pools

  # 会議削除
  deleteMeeting(meeting_id: ID!): Meeting
    @aws_cognito_user_pools

  # Google Calendar 同期
  syncCalendar(input: SyncCalendarInput): CalendarSyncResult
    @aws_cognito_user_pools

  # Google Meet 録画同期（Meet REST API v2）
  syncMeetRecordings(input: SyncMeetRecordingsInput): RecordingSyncResult
    @aws_cognito_user_pools

  # 録画を分析開始
  analyzeRecording(
    drive_file_id: String!
    recording_name: String!
  ): Recording
    @aws_cognito_user_pools

  # 会議の録画設定更新
  updateMeetingRecordingConfig(
    meeting_id: ID!
    auto_recording: Boolean!
    auto_transcription: Boolean
  ): Meeting
    @aws_cognito_user_pools

  # ========================================
  # Google OAuth Mutations
  # ========================================

  # Google アカウント接続（認証コードをトークンに交換）
  connectGoogle(input: ConnectGoogleInput!): GoogleConnectionResult
    @aws_cognito_user_pools

  # Google アカウント接続解除
  disconnectGoogle: GoogleConnectionResult
    @aws_cognito_user_pools

  # ========================================
  # Interview Project Mutations
  # ========================================

  # プロジェクト作成
  createInterviewProject(input: CreateInterviewProjectInput!): InterviewProject
    @aws_cognito_user_pools

  # プロジェクト更新
  updateInterviewProject(input: UpdateInterviewProjectInput!): InterviewProject
    @aws_cognito_user_pools

  # プロジェクト削除
  deleteInterviewProject(project_id: ID!): InterviewProject
    @aws_cognito_user_pools
}

input CreateInterviewInput {
  interview_id: ID!
  project_id: String
  segment: String!
  status: String
  analysis_key: String
  transcript_key: String
  video_key: String
  diarization_key: String
  total_score: Int
  user_id: String
  file_name: String
  file_size: Int
  execution_arn: String
}

input CreateInterviewProjectInput {
  title: String!
  description: String
  recruitment_criteria: String
  research_questions: String
  target_persona: String
}

input UpdateInterviewProjectInput {
  project_id: ID!
  title: String
  description: String
  recruitment_criteria: String
  research_questions: String
  target_persona: String
  status: ProjectStatus
}

input UpdateInterviewInput {
  interview_id: ID!
  project_id: String
  segment: String
  status: String
  analysis_key: String
  transcript_key: String
  video_key: String
  diarization_key: String
  total_score: Int
  progress: Int
  current_step: String
  error_message: String
}

type Subscription {
  # インタビュー作成イベント購読
  onCreateInterview: Interview
    @aws_subscribe(mutations: ["createInterview"])
    @aws_cognito_user_pools

  # インタビュー更新イベント購読
  onUpdateInterview: Interview
    @aws_subscribe(mutations: ["updateInterview"])
    @aws_cognito_user_pools

  # 会議作成イベント購読
  onCreateMeeting: Meeting
    @aws_subscribe(mutations: ["createMeeting"])
    @aws_cognito_user_pools

  # 会議更新イベント購読
  onUpdateMeeting: Meeting
    @aws_subscribe(mutations: ["updateMeeting"])
    @aws_cognito_user_pools
}

# ========================================
# Google Meet Integration Types
# ========================================

enum MeetingStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  RECORDING_AVAILABLE
  PROCESSING
  ANALYZED
}

type Meeting @aws_cognito_user_pools {
  meeting_id: ID!
  user_id: String!
  title: String!
  description: String
  start_time: AWSDateTime!
  end_time: AWSDateTime!
  status: MeetingStatus!
  google_calendar_event_id: String
  google_meet_space_id: String
  google_meet_uri: String
  auto_recording: Boolean
  auto_transcription: Boolean
  recording_file_id: String
  recording_s3_key: String
  interview_id: String
  created_at: AWSDateTime!
  updated_at: AWSDateTime
}

type MeetingConnection @aws_cognito_user_pools {
  items: [Meeting!]!
  nextToken: String
}

type CalendarSyncResult @aws_cognito_user_pools {
  success: Boolean!
  synced_count: Int!
  new_meetings: [Meeting!]
  updated_meetings: [Meeting!]
  error_message: String
}

input CreateMeetingInput {
  title: String!
  description: String
  start_time: AWSDateTime!
  end_time: AWSDateTime!
  auto_recording: Boolean
  auto_transcription: Boolean
}

input UpdateMeetingInput {
  meeting_id: ID!
  title: String
  description: String
  start_time: AWSDateTime
  end_time: AWSDateTime
  status: MeetingStatus
  auto_recording: Boolean
  auto_transcription: Boolean
  recording_file_id: String
  recording_s3_key: String
  interview_id: String
}

input SyncCalendarInput {
  start_date: AWSDateTime
  end_date: AWSDateTime
  max_results: Int
}

# ========================================
# Recording Types (Google Meet REST API v2)
# ========================================

type Recording @aws_cognito_user_pools {
  recording_name: String!
  conference_record: String!
  space: String
  start_time: AWSDateTime
  end_time: AWSDateTime
  drive_file_id: String!
  export_uri: String
  status: RecordingStatus
  meeting_id: String
  interview_id: String
}

enum RecordingStatus {
  PENDING
  DOWNLOADING
  DOWNLOADED
  ANALYZING
  ANALYZED
  ERROR
}

type RecordingSyncResult @aws_cognito_user_pools {
  success: Boolean!
  conference_records_count: Int!
  recordings_found: [Recording!]!
  recordings_downloaded: [Recording!]
  error_message: String
}

input SyncMeetRecordingsInput {
  days_back: Int
}

# ========================================
# Google OAuth Types
# ========================================

type GoogleAuthUrlResponse @aws_cognito_user_pools {
  auth_url: String!
  state: String!
}

type GoogleConnectionStatus @aws_cognito_user_pools {
  connected: Boolean!
  email: String
  scopes: [String!]
  expires_at: AWSDateTime
  is_expired: Boolean
}

type GoogleConnectionResult @aws_cognito_user_pools {
  success: Boolean!
  email: String
  error_message: String
}

input ConnectGoogleInput {
  code: String!
  redirect_uri: String!
  state: String!
}

schema {
  query: Query
  mutation: Mutation
  subscription: Subscription
}
